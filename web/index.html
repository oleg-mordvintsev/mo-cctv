<!DOCTYPE html>
<html>
<head>
    <title>MO-CCTV видео плеер</title>
    <meta charset="UTF-8">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .video-list {
            margin-bottom: 30px;
        }
        .video-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fafafa;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .video-item:hover {
            background: #e8f4fd;
            border-color: #007bff;
        }
        .video-item.selected {
            background: #d1ecff;
            border-color: #007bff;
            border-width: 2px;
        }
        .video-item h3 {
            margin: 0;
            color: #555;
            font-size: 16px;
        }
        .video-item .size {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }
        .player-container {
            position: sticky;
            top: 20px;
            background: white;
            padding: 20px;
            border: 2px solid #7c7c7c;
            border-radius: 8px;
            z-index: 10;
        }
        video {
            width: 100%;
            max-height: 500px;
            background: #000;
        }
        .no-video {
            text-align: center;
            color: #888;
            padding: 40px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .filter-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            position: relative;
            z-index: 5;
        }
        .filter-select {
            padding: 8px 12px;
            margin-right: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
        }
        .filter-select:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>MO-CCTV видео записи</h1>

    <div class="player-container" id="playerContainer" style="display: none;">
        <h2 id="currentVideoTitle">Выберите видео для воспроизведения</h2>
        <video id="videoPlayer" controls>Видео тег не поддерживается вашим браузером</video>
    </div>

    <div class="video-list">
        <h2>Доступные видео записи</h2>

        <div class="filter-container" id="filterContainer" style="display: none;">
            <select id="prefixSelect" class="filter-select" onchange="filterByPrefix()">
                <option value="">Все камеры</option>
            </select>
            <select id="dateSelect" class="filter-select" onchange="filterByDate()">
                <option value="">Выберите дату</option>
            </select>
            <select id="hourSelect" class="filter-select" onchange="filterByHour()">
                <option value="">Выберите час</option>
            </select>
        </div>

        <div id="videoList"></div>
        <div id="loading" class="loading">Загрузка видео...</div>
        <div id="noVideos" class="no-video" style="display: none;">Нет видео записей</div>
    </div>
</div>

<script>
    let allVideos = [];
    let filteredVideos = [];

    async function loadVideos() {
        try {
            const response = await fetch('/records/');
            if (!response.ok) {
                throw new Error('Ошибка загрузки');
            }

            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');

            allVideos = Array.from(doc.querySelectorAll('a[href$=".mp4"]'))
                .filter(link => !link.href.includes('index.html'))
                .map(link => {
                    const urlParts = link.href.split('/');
                    const filename = decodeURIComponent(urlParts[urlParts.length - 1]);

                    // Извлекаем дату из названия файла (последние 23 символа без расширения)
                    const dateString = filename.slice(-23, -4);
                    // Извлекаем префикс (всё что до даты)
                    const prefix = filename.slice(0, -24);

                    // Парсим дату и время
                    const [datePart, timePart] = dateString.split('_');
                    const [hour] = timePart.split('-');

                    return {
                        name: filename,
                        url: `/records/${filename}`,
                        size: link.nextSibling?.textContent?.trim() || '',
                        date: datePart, // "2025-08-29"
                        hour: hour,     // "21"
                        prefix: prefix, // префикс имени файла
                        dateString: dateString // полная строка даты-времени
                    };
                })
                .sort((a, b) => b.name.localeCompare(a.name));

            const loading = document.getElementById('loading');
            const noVideos = document.getElementById('noVideos');

            loading.style.display = 'none';

            if (allVideos.length === 0) {
                noVideos.style.display = 'block';
                return;
            }

            // Показываем контейнер с фильтрами
            document.getElementById('filterContainer').style.display = 'block';

            // Заполняем все фильтры
            populateFilters();
            // Показываем все видео по умолчанию
            displayVideos(allVideos);

        } catch (error) {
            console.error('Error loading videos:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('noVideos').style.display = 'block';
            document.getElementById('noVideos').textContent = 'Ошибка загрузки видео. Необходимо проверить конфигурацию.';
        }
    }

    function populateFilters() {
        populatePrefixFilter();
        populateDateFilter();
        updateHourSelectState();
    }

    function populatePrefixFilter() {
        const prefixSelect = document.getElementById('prefixSelect');
        // Получаем уникальные префиксы
        const prefixes = [...new Set(allVideos.map(video => video.prefix))].sort();

        prefixSelect.innerHTML = '<option value="">Все камеры</option>';
        prefixes.forEach(prefix => {
            const option = document.createElement('option');
            option.value = prefix;
            option.textContent = prefix || 'Без префикса';
            prefixSelect.appendChild(option);
        });
    }

    function populateDateFilter() {
        const dateSelect = document.getElementById('dateSelect');
        // Получаем уникальные даты и сортируем от новых к старым
        const dates = [...new Set(allVideos.map(video => video.date))].sort().reverse();

        dateSelect.innerHTML = '<option value="">Выберите дату</option>';
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            dateSelect.appendChild(option);
        });
    }

    function updateHourSelectState() {
        const dateSelect = document.getElementById('dateSelect');
        const hourSelect = document.getElementById('hourSelect');

        if (dateSelect.value) {
            hourSelect.disabled = false;
            hourSelect.style.opacity = '1';
            populateHourFilter();
        } else {
            hourSelect.disabled = true;
            hourSelect.style.opacity = '0.6';
            hourSelect.innerHTML = '<option value="">Сначала выберите дату</option>';
        }
    }

    function populateHourFilter() {
        const selectedDate = document.getElementById('dateSelect').value;
        const selectedPrefix = document.getElementById('prefixSelect').value;
        const hourSelect = document.getElementById('hourSelect');

        if (selectedDate) {
            // Получаем уникальные часы с учетом префикса и даты
            const hours = [...new Set(allVideos
                .filter(video => {
                    const matchesDate = video.date === selectedDate;
                    const matchesPrefix = !selectedPrefix || video.prefix === selectedPrefix;
                    return matchesDate && matchesPrefix;
                })
                .map(video => video.hour)
            )].sort((a, b) => parseInt(b) - parseInt(a)); // Новые часы сверху

            hourSelect.innerHTML = '<option value="">Все часы</option>';
            hours.forEach(hour => {
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = `${hour}:00`;
                hourSelect.appendChild(option);
            });
        }
    }

    function filterVideos() {
        const selectedPrefix = document.getElementById('prefixSelect').value;
        const selectedDate = document.getElementById('dateSelect').value;
        const selectedHour = document.getElementById('hourSelect').value;

        filteredVideos = allVideos.filter(video => {
            const matchesPrefix = !selectedPrefix || video.prefix === selectedPrefix;
            const matchesDate = !selectedDate || video.date === selectedDate;
            const matchesHour = !selectedHour || video.hour === selectedHour;

            return matchesPrefix && matchesDate && matchesHour;
        });

        displayVideos(filteredVideos);
    }

    function filterByPrefix() {
        updateHourSelectState();
        filterVideos();
    }

    function filterByDate() {
        updateHourSelectState();
        filterVideos();
    }

    function filterByHour() {
        filterVideos();
    }

    function formatDate(dateString) {
        const [datePart, timePart] = dateString.split('_');
        const [year, month, day] = datePart.split('-');
        const [hour, minute, second] = timePart.split('-');

        const inputDate = new Date(Date.UTC(
            parseInt(year),
            parseInt(month) - 1,
            parseInt(day),
            parseInt(hour),
            parseInt(minute),
            parseInt(second)
        ));

        // Русские названия месяцев
        const months = [
            'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
            'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
        ];

        const dayNum = inputDate.getUTCDate();
        const monthName = months[inputDate.getUTCMonth()];
        const yearNum = inputDate.getUTCFullYear();
        const hours = inputDate.getUTCHours().toString().padStart(2, '0');
        const minutes = inputDate.getUTCMinutes().toString().padStart(2, '0');

        return `${dayNum} ${monthName} ${yearNum} ${hours}:${minutes}`;
    }

    function displayVideos(videos) {
        const videoList = document.getElementById('videoList');
        videoList.innerHTML = '';

        if (videos.length === 0) {
            document.getElementById('noVideos').style.display = 'block';
            document.getElementById('noVideos').textContent = 'Нет видео для выбранных фильтров';
            return;
        }

        document.getElementById('noVideos').style.display = 'none';

        const currentVideoTitle = document.getElementById('currentVideoTitle').textContent;
        const newestVideo = allVideos.length > 0 ? allVideos[0].name : null;

        videos.forEach((video, index) => {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';

            // Проверяем, является ли это видео текущим выбранным
            if (video.name === currentVideoTitle) {
                videoItem.classList.add('selected');
            }

            // Проверяем, является ли это видео самым новым из всех доступных
            const isNewest = video.name === newestVideo;
            const warningText = isNewest ?
                '<div style="color: #ff6b6b; font-size: 14px; margin-top: 5px">⚠️ <i>Возможно, запись еще идет. Видео может не воспроизводиться</i></div>' :
                '';

            videoItem.innerHTML = `
            <h3>${video.name}</h3>
            <div class="size">${formatDate(video.dateString)}<!-- | ${video.size}--></div>
            ${warningText}
        `;

            videoItem.addEventListener('click', () => {
                playVideo(video.url, video.name);
            });

            videoList.appendChild(videoItem);
        });
    }

    function playVideo(url, title) {
        const player = document.getElementById('videoPlayer');
        const container = document.getElementById('playerContainer');
        const titleElement = document.getElementById('currentVideoTitle');

        // Убираем выделение со всех элементов
        document.querySelectorAll('.video-item.selected').forEach(item => {
            item.classList.remove('selected');
        });

        // Находим и выделяем выбранный элемент
        const videoItems = document.querySelectorAll('.video-item');
        videoItems.forEach(item => {
            if (item.querySelector('h3').textContent === title) {
                item.classList.add('selected');
            }
        });

        titleElement.textContent = title;
        player.src = url;
        container.style.display = 'block';

        container.scrollIntoView({ behavior: 'smooth' });

        player.play().catch(error => {
            console.log('Autoplay prevented:', error);
        });
    }

    document.addEventListener('DOMContentLoaded', loadVideos);
</script>
</body>
</html>